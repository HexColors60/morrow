<template>
  <div>
    <v-card min-width="500px">
      <v-card-title>
        {{ id }}
        <v-spacer></v-spacer>
        <v-text-field
          dense
          v-model="search"
          append-icon="mdi-filter-outline"
          label="filter"
          single-line
          hide-details
          clearable
        />
      </v-card-title>

      <v-card-text>
        <v-data-table
          :headers="headers"
          :items="component_fields"
          item-key="_key"
          group-by="_comp_id"
          :hide-default-footer="true"
          :hide-default-header="true"
          :disable-pagination="true"
          :disable-sort="true"
          :search="search"
          dense
        >
          <template #group.header="{ group: comp_id, toggle: toggle }">
            <td colspan="3" @click="toggle()">
              <v-tooltip top transition="fade-transition">
                <template v-slot:activator="{ on }">
                  <span v-on="on">
                    {{ components[comp_id].name }}
                  </span>
                </template>
                {{ components[comp_id].desc }}
              </v-tooltip>
            </td>
          </template>

          <template #item._field="{ item }">
            <v-tooltip top transition="fade-transition">
              <template v-slot:activator="{ on }">
                <span v-on="on">
                  {{ item._field }}
                </span>
              </template>
              {{ item.desc }}
            </v-tooltip>
          </template>

          <template #item.value="{ item }">
            <div v-if="item.value instanceof Array">
              <ul>
                <li
                  v-for="(value, index) in item.value"
                  :key="item.key + '[' + index + ']'"
                >
                  <router-link
                    v-if="item.type[0] === 'entity'"
                    :to="'/entity/' + value"
                  >
                    <entity-with-tooltip bottom :id="value" />
                  </router-link>
                  <span v-else>
                    {{ value }}
                  </span>
                </li>
              </ul>
            </div>
            <div v-else-if="item.value instanceof Object">
              TODO Object: {{ item.value }}
            </div>
            <div v-else>
              <router-link
                v-if="item.type === 'entity' && item.value"
                :to="'/entity/' + item.value"
              >
                <entity-with-tooltip bottom :id="item.value" />
              </router-link>
              <span v-else>
                {{ item.value }}
              </span>
            </div>
          </template>

          <template #item.actions="{ item }">
            <div style="white-space:nowrap">
              <v-tooltip top transition="fade-transition">
                <template v-slot:activator="{ on }">
                  <v-icon small v-on="on" @click="edit_field(item)"
                    >mdi-pencil-outline</v-icon
                  >
                </template>
                edit
              </v-tooltip>

              <v-tooltip top transition="fade-transition">
                <template v-slot:activator="{ on }">
                  <v-icon small v-on="on">mdi-rotate-left</v-icon>
                </template>
                set to default
              </v-tooltip>

              <v-tooltip top transition="fade-transition">
                <template v-slot:activator="{ on }">
                  <v-icon
                    small
                    v-on="on"
                    @click="set_field(item._comp_id, item._field, item.default)"
                  >
                    mdi-close
                  </v-icon>
                </template>
                clear
              </v-tooltip>
            </div>
          </template>
        </v-data-table>
      </v-card-text>
    </v-card>

    <v-dialog v-model="edit.active" max-width="500px">
      <v-card>
        <v-card-title>
          {{ edit.name }}
        </v-card-title>

        <v-card-subtitle>
          {{ edit.desc }}
        </v-card-subtitle>

        <v-card-text>
          <entity-autocomplete
            v-if="edit.type === 'entity'"
            v-model="edit.value"
          />
          <v-text-field
            v-else-if="edit.type === 'Integer'"
            v-model.number="edit.value"
            type="number"
          />
          <v-textarea
            v-else-if="typeof(edit.value) === 'string'
                && edit.value.indexOf('\n') != -1"
            v-model="edit.value"
            auto-grow
            autofocus
            filled
            counter
          />
          <v-text-field v-else v-model="edit.value" />
        </v-card-text>

        <v-card-actions>
          <v-spacer />
          <v-btn text @click="edit.active = false">Cancel</v-btn>
          <v-btn
            class="primary"
            text
            @click="set_field(edit.comp_id, edit.field, edit.value)"
          >
            Save
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <v-snackbar v-model="snack" :timeout="3000" :color="snack_color">
      {{ snack_text }}
      <v-btn text @click="snack = false">Close</v-btn>
    </v-snackbar>
  </div>
</template>

<script>
export default {
  name: "entity-card",
  props: {
    id: {
      type: String,
      required: true
    }
  },
  data: () => ({
    headers: [
      { text: "field", value: "_field" },
      { text: "value", value: "value" },
      { text: "actions", value: "actions" }
    ],
    components: {},
    component_fields: [],
    edit: { active: false },
    snack: false,
    snack_color: "info",
    snack_text: "",
    search: '',
    rules: {
    }
  }),
  computed: {
    base: function() {
      var metadata = this.get_component("metadata");
      return metadata ? metadata.fields.base.value : [];
    }
  },
  mounted: async function() {
    var entity = await this.$morrow.get_entity(this.id);
    var components = entity.components.sort((a, b) => {
      return a.name > b.name ? 1 : -1;
    });

    components.forEach(comp => {
      this.components[comp.id] = comp;
      for (let name of Object.keys(comp.fields)) {
        let field = comp.fields[name];
        this.component_fields.push(
          this._.merge(field, {
            _comp_id: comp.id,
            _comp_name: comp.name,
            _key: comp.id + "." + name,
            _field: name
          })
        );
      }
    });
  },
  methods: {
    edit_field(field) {
      this.edit.comp_id = field._comp_id;
      this.edit.field = field._field;
      this.edit.value = field.value;
      this.edit.name = field._comp_name + "." + field._field;
      this.edit.desc = field.desc;
      this.edit.type = field.type;
      this.edit.active = true;
    },

    set_field(comp_id, field, value) {
      this.$morrow.set_component_field(comp_id, field, value).then(() => {
        this.snack = true;
        this.snack_color = "success";
        this.snack_text = "Field updated";
        this.edit.active = false;
        this.components[comp_id].fields[field].value = value;
      });
    },
    open() {
      console.log("opened");
    },
    get_component(name) {
      return this._.find(this.components, function(comp) {
        return comp.name == name;
      });
    }
  }
};
</script>

<style>
.component {
  border-top: 2px solid gray;
}
.row.field {
  border-left: 2px solid gray;
}
.tooltip.tooltip-after-open {
  opacity: 1;
}
</style>
